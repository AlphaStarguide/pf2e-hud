#pf2e-hud-persistent {
    --panel-background: url("../../../ui/denim075.png") repeat;
    --panel-gap: 3px;

    --column-1fr: 3.8em;
    --column-2fr: calc(var(--column-1fr) * 2);
    --columns-icon: 2.2em;

    --row-1fr: 2.05em;
    --row-2fr: calc(var(--row-1fr) * 2);
    --row-3fr: calc(var(--row-1fr) * 3);

    --flash-color: 255, 255, 0;
    --flash-inset-blur: 30px;
    --flash-inset-color: rgba(var(--flash-color), 0.55);
    --flash-outset-blur: 20px;
    --flash-outset-color: rgb(var(--flash-color));

    --sidebar-arrow-color: #2c2c2c;

    align-self: start;
    margin-bottom: var(--panel-gap);
    display: grid;
    gap: var(--panel-gap);
    margin-left: -50px;

    grid-template-columns:
        [full-start menu-start] var(--columns-icon)
        [menu-end portrait-start] 11em
        [portrait-end info-start] var(--columns-icon)
        [info-end statistics-start] var(--column-2fr)
        [statistics-end resources-start] var(--column-1fr)
        [resources-end sidebars-start] 9em
        [sidebars-end stretch-start] auto
        [stretch-end full-end];
    grid-template-rows:
        [effects-start] auto
        [effects-end top-start] var(--row-1fr)
        [top-end middle-start] var(--row-3fr)
        [middle-end bottom-start] var(--row-2fr)
        [bottom-end];

    [data-panel],
    [data-panel="menu"] .group {
        padding: var(--panel-gap);
        background: var(--panel-background);
        border: var(--outer-border);
        border-radius: var(--outer-border-radius);
        pointer-events: all;
    }

    [data-panel="menu"] {
        grid-column: menu;
        grid-row: top / bottom;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        background: none;
        border: none;
        padding: 0;

        .group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;

            &.single {
                padding-block: calc(var(--panel-gap) + 1px);
            }
        }
    }

    [data-panel="effects"] {
        grid-column: full;
        grid-row: effects;
    }

    [data-panel="name"] {
        grid-column: portrait;
        grid-row: top;
        align-self: start;
        border: none;
        padding-block: 2px;
        background: linear-gradient(
            90deg,
            rgba(0, 0, 0, 0.1) 0%,
            rgba(0, 0, 0, 0.6) 20%,
            rgba(0, 0, 0, 0.8) 50%,
            rgba(0, 0, 0, 0.6) 80%,
            rgba(0, 0, 0, 0.1) 100%
        );
    }

    [data-panel="effects"] {
        grid-column: full;
        grid-row: effects;
    }

    [data-panel="stats"] {
        grid-column: portrait;
        grid-row: middle / bottom;
        align-self: end;
        border: none;
        background-color: #0000007d;
        display: none;
    }

    [data-panel="portrait"] {
        z-index: -1;
        position: relative;
        grid-column: portrait;
        grid-row: top / bottom;

        .avatar {
            position: absolute;
            inset: 0;
            background-position: center top;
            background-repeat: no-repeat;
            background-size: contain;

            &[data-action] {
                cursor: pointer;
                box-shadow: inset 0 0 8px 1px var(--outer-border-color);
            }
        }
    }

    [data-panel="info"] {
        grid-column: info;
        grid-row: top / middle;
        grid-template-columns: auto;
        grid-template-rows: repeat(5, 1fr);
        justify-content: center;
    }

    [data-panel="resources"] {
        grid-column: resources;
        grid-row: middle;
    }

    [data-panel="details"] {
        grid-column: statistics;
        grid-row: top;
        grid-template-columns: repeat(2, 1fr);
    }

    [data-panel="statistics"] {
        grid-column: statistics;
        grid-row: middle;
        grid-template-rows: 1fr 1fr 1fr;
        grid-auto-flow: column;
    }

    [data-panel="alliance"] {
        grid-column: resources;
        grid-row: top;
    }

    [data-panel="shortcuts"] {
        grid-column: resources / full;
        grid-row: middle;

        &.character {
            grid-column: sidebars / full;
        }
    }

    [data-panel="sidebars"] {
        grid-column: sidebars;
        grid-row: top;
        grid-template-columns: repeat(5, 1fr);
        align-items: center;

        [data-sidebar].active {
            position: relative;

            &::before {
                --arrow-size: calc(var(--sidebar-external-padding) * 2);

                position: absolute;
                content: "";
                left: 50%;
                transform: translate(-50%);
                bottom: calc(100% + 1px);
                width: 0;
                height: 0;
                border-left: var(--arrow-size) solid transparent;
                border-right: var(--arrow-size) solid transparent;
                border-top: var(--arrow-size) solid var(--sidebar-arrow-color);
            }
        }
    }

    &.cleaned {
        [data-action="toggle-clean"]:not(.cleaned) {
            display: none;
        }

        [data-panel="portrait"]:hover ~ [data-panel="stats"],
        [data-panel="stats"]:hover {
            display: grid;
        }
    }

    &:not(.cleaned) {
        [data-action="toggle-clean"].cleaned {
            display: none;
        }

        [data-panel="stats"] {
            display: grid;
        }
    }

    &.locked {
        [data-action="toggle-hotbar-lock"]:not(.locked) {
            display: none;
        }
    }

    &:not(.locked) {
        [data-action="toggle-hotbar-lock"].locked {
            display: none;
        }
    }

    &.muted {
        [data-action="mute-sound"]:not(.muted) {
            display: none;
        }
    }

    &:not(.muted) {
        [data-action="mute-sound"].muted {
            display: none;
        }
    }

    #hotbar {
        grid-column: info / full;
        grid-row: bottom;
        flex-wrap: nowrap;
        height: var(--hotbar-size);
        margin: 0;
        padding: 0;
        transform: none;
        gap: var(--panel-gap);
        opacity: 1;

        #action-bar {
            width: auto;
            gap: var(--panel-gap);

            li {
                border-radius: var(--outer-border-radius);
                background: var(--panel-background);

                span {
                    background: var(--panel-background);
                }
            }
        }

        #hotbar-controls-left,
        #hotbar-controls-right > div {
            display: none;
        }

        #hotbar-page-controls {
            --button-size: 1.4em;

            background: var(--panel-background);
            border-radius: var(--outer-border-radius);

            button {
                font-size: var(--hud-font-size);
                color: var(--color);
            }
        }
    }
}

#pf2e-hud-persistent [data-panel="shortcuts"] {
    --shortcut-width: calc(var(--row-3fr) / 2);

    display: grid;
    grid-template-rows: repeat(2, 1fr);
    grid-auto-flow: column;
    gap: var(--panel-gap);
    background: none;
    border: none;
    padding: 0;
    justify-self: start;

    .shortcut {
        border: var(--outer-border);
        border-style: dashed;
        border-radius: var(--outer-border-radius);
        background: rgb(0 0 0 / 37%);
        width: var(--shortcut-width);
    }
}

// https://github.com/foundryvtt/pf2e/blob/7baadf276f3d3f13fd77adf411387312ab287042/src/styles/system/_effects-panel.scss
#pf2e-hud-persistent [data-panel="effects"] {
    --icon-height: 32px;

    background: none;
    border: none;
    padding: 0;

    article {
        display: flex;
        gap: var(--panel-gap);
        overflow: auto;
        pointer-events: initial;
        scrollbar-gutter: stable;

        .effect-item {
            border-radius: 4px;
            display: flex;
            justify-content: end;

            &[data-badge-type="formula"] .icon {
                cursor: pointer;

                /* Show fa-dice-d20 */
                &:hover::before {
                    content: "\f6cf";
                    background: rgba(0, 0, 0, 0.5);
                    font-family: var(--font-awesome);
                    font-weight: 900;
                    font-size: var(--font-size-20);
                    color: var(--text-light);
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding-bottom: 4px; // offset
                }
            }

            > .icon {
                align-items: center;
                background-repeat: no-repeat;
                background-size: contain;
                box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.5);
                border: 1px solid var(--color-cool-4);
                border-radius: 4px;
                color: transparent;
                display: flex;
                justify-content: center;
                position: relative;
                height: var(--icon-height);
                width: var(--icon-height);

                &.aura {
                    border-radius: 50%;
                    box-shadow: 0px 0px 6px 3px white;
                }

                &.unidentified {
                    filter: drop-shadow(0 0 8px var(--visibility-gm-bg));
                }

                .expired {
                    position: absolute;
                    left: 0;
                    bottom: 0;
                    width: 100%;
                    padding: 0;
                    font-family: var(--sans-serif);
                    font-size: var(--font-size-9);
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                    text-rendering: optimizeLegibility;
                    color: var(--text-light);
                    background-color: var(--primary);
                    overflow: hidden;
                    text-overflow: ellipsis;
                }

                .linked {
                    position: absolute;
                    display: inline-block;
                    bottom: 0;
                    right: 0;
                    padding: 0px 2px;
                    color: var(--text-light);
                    background-color: rgba(0, 0, 0, 0.75);
                }

                .value-wrapper {
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    max-width: calc(100% + 2px);
                    padding: 0px 2px;

                    color: var(--text-light);
                    background-color: rgba(0, 0, 0, 0.75);
                    font-size: var(--font-size-11);
                    letter-spacing: -0.05em;
                    white-space: nowrap;
                    overflow: hidden;

                    border-radius: 0 2px 0 0;

                    .value {
                        overflow: hidden;
                        text-overflow: ellipsis;
                        strong {
                            display: inline-block;
                            padding-right: 1px; // prevent clipping
                        }
                    }
                }
            }
        }

        > hr {
            margin: 0;
            height: var(--icon-height);
            background: none;
            width: 0;
            border-right: 1px solid #e9db8d;
            margin-inline: 1px;
        }
    }
}
